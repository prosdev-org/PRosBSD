add_custom_command(
    OUTPUT MBR.BIN
    COMMAND ${CMAKE_ASM_COMPILER} ${CMAKE_ASM_FLAGS} -c ${CMAKE_CURRENT_SOURCE_DIR}/MBR.s -o ${CMAKE_CURRENT_BINARY_DIR}/MBR.o
    COMMAND ${CMAKE_LINKER} ${CMAKE_LINKER_FLAGS} -Ttext 0x7C00 -o ${CMAKE_CURRENT_BINARY_DIR}/MBR.BIN ${CMAKE_CURRENT_BINARY_DIR}/MBR.o
    COMMAND ${CMAKE_OBJCOPY} ${CMAKE_OBJCOPY_FLAGS} ${CMAKE_CURRENT_BINARY_DIR}/MBR.BIN
    COMMENT "Building MBR (stage 1) of fd.img"
)

add_custom_command(
    OUTPUT SETUP.BIN
    COMMAND ln -s ${CMAKE_CURRENT_SOURCE_DIR}/FONT.FNT ${CMAKE_CURRENT_BINARY_DIR}/FONT.FNT
    COMMAND ${CMAKE_ASM_COMPILER} ${CMAKE_ASM_FLAGS} -c ${CMAKE_CURRENT_SOURCE_DIR}/setup.s -o ${CMAKE_CURRENT_BINARY_DIR}/SETUP.o
    COMMAND ${CMAKE_LINKER} ${CMAKE_LINKER_FLAGS} -Ttext 0x0600 -o ${CMAKE_CURRENT_BINARY_DIR}/SETUP.BIN ${CMAKE_CURRENT_BINARY_DIR}/SETUP.o
    COMMAND ${CMAKE_OBJCOPY} ${CMAKE_OBJCOPY_FLAGS} ${CMAKE_CURRENT_BINARY_DIR}/SETUP.BIN
    COMMENT "Building setup (stage 2) of fd.img"
)

add_custom_command(
    OUTPUT KERNEL_ENTRY.o
    COMMAND ${CMAKE_ASM_COMPILER} ${CMAKE_ASM_FLAGS} -c ${CMAKE_CURRENT_SOURCE_DIR}/kernel.s -o ${CMAKE_CURRENT_BINARY_DIR}/KERNEL_ENTRY.o
    COMMENT "Building 32-bit kernel entry"
)

add_custom_target(boot
    DEPENDS MBR.BIN
    DEPENDS SETUP.BIN
    DEPENDS KERNEL_ENTRY.o
)
